#include<stdio.h>
#include<conio.h>
#include<stdlib.h>
#include<windows.h>
#include<stdbool.h>
#include<math.h>
#define height 30
#define width 120
	bool gameover;
	int x,y,score,g2x,g2y;  //x,y are pacman's co-ortinates
	enum eDirection{STOP=0, LEFT,RIGHT,UP,DOWN};
	enum ghostDirection2{STOP2=0, LEFT2,RIGHT2,UP2,DOWN2};
	enum eDirection dir;
    enum ghostDirection2 dir2;
    char grid[40][130]= //30 * 120
        {
            "=======================================================================================================================",
            "=======================================================================================================================",
            "||.........................||.............................................................||.........................||",
            "||.........................||.............................................................||.........................||",
            "||.........................||.............................................................||.........................||",
            "||.........................||..........=========================================..........||.........................||",
            "||.................||......||.............................................................||......||.................||",
            "||.................||......||.............................................................||......||.................||",
            "||....||=====||....||.............................................................................||....||=====||....||",
            "||....||.....||....||.............................................................................||....||.....||....||",
            "||....||.....||....||....................||============...    ...============||...................||....||.....||....||",
            "||....||.....||....||....................||..................................||...................||....||.....||....||",
            "||....||.....||....||....................||..................................||...................||....||.....||....||",
            "||....||.....||....||....................||..................................||...................||....||.....||....||",
            "||.................||....................||..................................||...................||.................||",
            "||.................||....................||..................................||...................||.................||",
            "||.................||....................||..................................||...................||.................||",
            "||.................||....................||==================================||...................||.................||",
            "||.......||........||.............................................................................||........||.......||",
            "||.......||........||.............................................................................||........||.......||",
            "||.......||........||.............................................................................||........||.......||",
            "||.......||........||..............==================================================.............||........||.......||",
            "||.......||........||.............................................................................||........||.......||",
            "||.......||.................................................................................................||.......||",
            "||.......||.................................................................................................||.......||",
            "||.......||========================================..................=======================================||.......||",
            "||...................................................................................................................||",
            "||...................................................................................................................||",
            "=======================================================================================================================",
            "======================================================================================================================="

        };

    void gotoxy(short x, short y) {
    COORD pos = {x, y};
    SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), pos);
    }

    void main_menu(){
        char ch;
        int i,j;
        char title[7][58]=
            {
                    ".########.....###.....######..##.....##....###....##....##",
                    ".##.....##...##.##...##....##.###...###...##.##...###...##",
                    ".##.....##..##...##..##.......####.####..##...##..####..##",
                    ".########..##.....##.##.......##.###.##.##.....##.##.##.##",
                    ".##........#########.##.......##.....##.#########.##..####",
                    ".##........##.....##.##....##.##.....##.##.....##.##...###",
                    ".##........##.....##..######..##.....##.##.....##.##....##"


            };
        for(i=0;i<7;i++)
        {
        gotoxy(30,5+i);
        for(j=0;j<58;j++)
            printf("%c",title[i][j]);
        printf("\n");
        }
        gotoxy(50,20);
        printf("1.Play Game");
        gotoxy(50,21);
        printf("2.Quit ");
        loop:
            ch=getch();
        switch(ch){
            case '1':break;
            case '2':
                    gotoxy(50,22);
                    printf("Quitting...\n");
                    exit(0);
                    break;
            default:
                    goto loop;
                break;
        }
    }
    void loading_screen(){
        system("cls");
    int row,col,r,c,q;
    gotoxy(50,14);
    printf("loading...");
    gotoxy(44,15);
    for(r=1;r<=20;r++){
    for(q=0;q<=100000000;q++);
    printf("%c",176);}
}

	void Setup(){
		gameover=false;
		dir=STOP;
		x = width / 2;
		y = height / 2;
		g2x=25;
		g2y=6;
		score=0;
        main_menu();
        loading_screen();
	}

	void Draw()
	{
		int i,j;
		char sv2=' ';
		system("cls");


        if(grid[g2y][g2x]=='.') sv2='.';
        if((grid[g2y][g2x]=='.') || (grid[g2y][g2x]==' '))
            grid[g2y][g2x]='Q';
        if(grid[y][x]=='.') score++;
		if((grid[y][x]=='.') || (grid[y][x]==' '))
            grid[y][x]='C';

		for(i=0;i<height;i++)
		{
            for(j=0;j<width;j++)
            {
                printf("%c",grid[i][j]);
                if(grid[i][j]=='C')
                {
                    grid[i][j]=' ';
                }
                if(grid[i][j]=='Q')
                {
                    if(sv2=='.')
                    {
                        grid[i][j]='.';
                    }
                    else if (sv2==' ')
                    {
                        grid[i][j]=' ';
                    }
                }
            }
        printf("\n");
		}
		gotoxy(55,5);
        printf("Score=%d",score);
	}

	void Input(){
		if(_kbhit()){
			switch(_getch()){                           //if user presses stuff then only getch() activates and hence takes input
				case 'a':
					dir=LEFT;
					break;

				case 'd':
					dir=RIGHT;
					break;

				case 'w':
					dir=UP;
					break;


				case 's':
					dir=DOWN;
					break;

				case 'x':
					gameover=true;
					break;
			}
		}
	}

    void ghost2randmove(){
         int r;
        r=(rand()%4)+1;
        switch(r){
        case 1:
                dir2 = LEFT2;
                break;
        case 2:
                dir2 = RIGHT2;
                break;
        case 3:
                dir2 =  UP2;
                break;
        case 4:
                dir2 = DOWN2;
                break;
        }
    }

    void ghost2targetmove(){
        int i,low,index=0;
        float dis[4];
        if(grid[g2y][g2x-1]!='*')
           {
            dis[0] = sqrt(pow(x-(g2x-1),2)+pow(y-g2y,2));
           }else dis[0]=50000;
        if(grid[g2y-1][g2x]!='*'){
            dis[1] = sqrt(pow(x-g2x,2)+pow(y-(g2y-1),2));}else dis[1]=50000;
        if(grid[g2y][g2x+1]!='*'){
            dis[2] = sqrt(pow(x-(g2x+1),2)+pow(y-g2y,2));}else dis[2]=50000;
        if(grid[g2y+1][g2x]!='*'){
            dis[3] = sqrt(pow(x-g2x,2)+pow(y-(g2y+1),2));}else dis[3]=50000;
        low=dis[0];
        for(i=0;i<4;i++){
            if(dis[i]<low)
            {
                low=dis[i];
                index=i;
            }
        }
        switch(index+1){
        case 1:
                dir2 = LEFT2;
                break;
        case 2:
                dir2 = UP2;
                break;
        case 3:
                dir2 =  RIGHT2;
                break;
        case 4:
                dir2 = DOWN2;
                break;
    }


}

	void Logic(){

        if(score<150) ghost2randmove();
        else
            ghost2targetmove();

			switch(dir2){
				case LEFT2:
					g2x--;
					if(grid[g2y][g2x]=='*')
                        g2x+=1;
					break;
				case RIGHT2:
					g2x++;
					if(grid[g2y][g2x]=='*')
                        g2x-=1;
					break;
				case UP2:
					g2y--;
					if(grid[g2y][g2x]=='*')
                        g2y+=1;
					break;
				case DOWN2:
					g2y++;
					if(grid[g2y][g2x]=='*')
                        g2y-=1;
					break;
			}
        switch(dir){                            //pacman's co-ordinate changes when corresponding key is pressed
				case LEFT:
					x--;
					if(grid[y][x]=='*')
                        x+=1;
					break;
				case RIGHT:
					x++;
					if(grid[y][x]=='*')
                        x-=1;
					break;
				case UP:
					y--;
					if(grid[y][x]=='*')
                        y+=1;
					break;
				case DOWN:
					y++;
					if(grid[y][x]=='*')
                        y-=1;
					break;
			}
		if(x>width) x=width-2;
		if(y>height) y=height-1;
		if(x<0) x=1;
		if(y<0)y=0;
		if(g2x==x && g2y==y) gameover=true;
		if (score==669) gameover=true;

	}
	void Game_Over(){
	    int i;
	    system("cls");
	    char end[7][90]=
        {
            " *******   *******   **       ** ********      *******  *           * ********  ******* ",
            "*         *       *  * *     * * *            *       *  *         *  *        *       *",
            "*         *       *  *  *   *  * *            *       *   *       *   *        *       *",
            "*   ****  *********  *   * *   * ********     *       *    *     *    ******** * ****** ",
            "*      *  *       *  *    *    * *            *       *     *   *     *        *   *    ",
            "*      *  *       *  *         * *            *       *      * *      *        *     *  ",
            " *******  *       *  *         * ********      *******        *       ******** *       *",
        };
        for(i=0;i<7;i++)
            {
                gotoxy(20,3+i);
                printf("%s\n",end[i]);
            }
        if(score==669)
        {
            gotoxy(45,14);
            printf("Congratulations you won:");
        }
		else
        {
            gotoxy(45,14);
            printf("Too bad....you lost..");
        }
        gotoxy(45,15);
        printf("Press any key to continue");
	}
	int main(){
		Setup();
		while(!gameover){
			Draw();
			Input();
			Logic();
			Sleep(50);
		}
        Game_Over();
        getch();
		return 0;
	}
